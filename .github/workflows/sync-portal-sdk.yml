name: Sync Portal SDK

on: 
  push:
    branches:  [main]
  workflow_dispatch:
  repository_dispatch: 
  workflow_call:

permissions: 
  contents: write
  pull-requests: write
  issues:  write

jobs:
  check-update:
    name: Check for SDK update
    runs-on:  ubuntu-latest
    outputs: 
      update_needed: ${{ steps.check.outputs.update_needed }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name:  Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          persist-credentials: true
          fetch-depth: 0

      - name: Fetch remote versions.json
        run: |
          set -euo pipefail
          
          # Download the file with User-Agent
          HTTP_CODE=$(curl -fsSL \
            -w "%{http_code}" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:146.0) Gecko/20100101 Firefox/146.0" \
            -o remote_versions.json \
            https://download.portal.battlefield.com/versions.json)
          
          # Check if download was successful
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to download versions.json (HTTP $HTTP_CODE)" >&2
            exit 1
          fi
          
          # Check if file is not empty
          if [ ! -s remote_versions.json ]; then
            echo "Downloaded versions.json is empty" >&2
            exit 1
          fi
          
          # Validate JSON
          if !  jq empty remote_versions.json 2>/dev/null; then
            echo "Downloaded file is not valid JSON:" >&2
            cat remote_versions.json >&2
            exit 1
          fi
          
          echo "Successfully fetched and validated remote versions.json"

      - name: Determine if update is needed
        id: check
        run: |
          set -euo pipefail
          
          # Try multiple possible version field names
          REMOTE_VERSION=$(jq -r '. version // .Version // .ver // empty' remote_versions.json)
          
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "Failed to read version from remote versions.json" >&2
            echo "Content of remote versions. json:" >&2
            cat remote_versions.json >&2
            exit 1
          fi

          LOCAL_VERSION=""
          if [ -f versions.json ]; then
            LOCAL_VERSION=$(jq -r '.version // . Version // .ver // empty' versions.json)
          fi

          echo "Remote version: $REMOTE_VERSION"
          echo "Local version:  ${LOCAL_VERSION:-<none>}"

          UPDATE_NEEDED="false"
          if [ -z "$LOCAL_VERSION" ]; then
            UPDATE_NEEDED="true"
          elif [ "$REMOTE_VERSION" != "$LOCAL_VERSION" ]; then
            UPDATE_NEEDED="true"
          fi

          echo "update_needed=$UPDATE_NEEDED" >> "$GITHUB_OUTPUT"
          echo "version=$REMOTE_VERSION" >> "$GITHUB_OUTPUT"

  sync-sdk: 
    name: Download, extract, and sync SDK
    runs-on:  ubuntu-latest
    needs: [check-update]
    if:  ${{ needs.check-update. outputs.update_needed == 'true' }}
    outputs: 
      branch: ${{ steps.push.outputs.branch }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: 
          ref: main
          persist-credentials: true
          fetch-depth:  0

      - name:  Fetch remote versions.json
        run: |
          set -euo pipefail
          
          HTTP_CODE=$(curl -fsSL \
            -w "%{http_code}" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:146.0) Gecko/20100101 Firefox/146.0" \
            -o versions.json \
            https://download.portal.battlefield.com/versions.json)
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to download versions.json (HTTP $HTTP_CODE)" >&2
            exit 1
          fi
          
          if !  jq empty versions.json 2>/dev/null; then
            echo "Downloaded file is not valid JSON" >&2
            exit 1
          fi

      - name: Download PortalSDK. zip
        run: |
          set -euo pipefail
          
          HTTP_CODE=$(curl -fsSL \
            -w "%{http_code}" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:146.0) Gecko/20100101 Firefox/146.0" \
            -o PortalSDK.zip \
            https://download.portal.battlefield.com/PortalSDK.zip)
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to download PortalSDK.zip (HTTP $HTTP_CODE)" >&2
            exit 1
          fi
          
          # Verify it's a valid ZIP file
          if ! unzip -t PortalSDK.zip >/dev/null 2>&1; then
            echo "Downloaded file is not a valid ZIP archive" >&2
            exit 1
          fi

      - name:  Unzip archive
        run:  |
          rm -rf tmp_unzip
          mkdir -p tmp_unzip
          unzip -q PortalSDK.zip -d tmp_unzip

      - name: Remove all tracked files except workflow
        run: |
          # Remove everything except .github folder and .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' !  -name '.github' ! -name 'tmp_unzip' !  -name 'PortalSDK.zip' ! -name 'versions.json' -exec rm -rf {} +

      - name: Copy required folders
        run:  |
          set -euo pipefail
          copy_dir() {
            SRC="$1"
            if [ -d "tmp_unzip/$SRC" ]; then
              mkdir -p "$SRC"
              rsync -a --delete "tmp_unzip/$SRC/" "$SRC/"
              echo "Copied:  $SRC"
            else
              echo "Warning: folder not found in zip: $SRC" >&2
            fi
          }
          copy_dir "FbExportData/levels"
          copy_dir "GodotProject/levels"
          copy_dir "GodotProject/objects"
          copy_dir "GodotProject/scripts"
          copy_dir "GodotProject/static"
          copy_dir "mods"

      - name:  Copy required files
        run: |
          set -euo pipefail
          copy_file() {
            SRC="$1"
            if [ -f "tmp_unzip/$SRC" ]; then
              mkdir -p "$(dirname "$SRC")"
              cp -f "tmp_unzip/$SRC" "$SRC"
              echo "Copied:  $SRC"
            else
              echo "Warning: file not found in zip: $SRC" >&2
            fi
          }
          copy_file "sdk. version.json"
          copy_file "tsconfig.json"
          copy_file "package.json"
          copy_file "package-lock.json"
          copy_file "README.html"
          copy_file "requirements.txt"
          # versions.json already saved from remote

      - name:  Clean up temporary files
        run:  |
          rm -rf tmp_unzip PortalSDK. zip

      - name: Commit and push to version branch
        id: push
        env:
          VERSION: ${{ needs.check-update.outputs.version }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users. noreply.github.com"

          BRANCH="v${VERSION}"
          echo "Creating branch:  $BRANCH"

          git checkout -b "$BRANCH"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "branch=" >> "$GITHUB_OUTPUT"
          else
            git commit -m "Update Portal SDK to v${VERSION}"
            git push -f origin "$BRANCH"
            echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          fi

  create-pr-and-issue: 
    name: Create Pull Request and Issue
    runs-on: ubuntu-latest
    needs: [check-update, sync-sdk]
    if: ${{ needs.sync-sdk.outputs.branch != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          persist-credentials: true

      - name: Create Pull Request
        id: pr
        env: 
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs. check-update.outputs.version }}
          BRANCH: ${{ needs.sync-sdk.outputs.branch }}
        run: |
          set -euo pipefail
          PR_TITLE="Update Portal SDK to v${VERSION}"
          PR_BODY="Automated update of Portal SDK to version ${VERSION}. 

          This PR includes:
          - Updated versions.json
          - Synced folders: FbExportData/levels, GodotProject/levels, GodotProject/objects, GodotProject/scripts, GodotProject/static, mods
          - Synced files: sdk.version.json, tsconfig.json, package. json, package-lock.json, README.html, requirements.txt

          Source: https://download.portal.battlefield.com/PortalSDK.zip"

          PR_URL=$(gh pr create --base main --head "$BRANCH" --title "$PR_TITLE" --body "$PR_BODY")
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Created PR: $PR_URL"

      - name: Create Issue and link to PR
        env: 
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs. check-update.outputs.version }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          PR_URL:  ${{ steps.pr.outputs. pr_url }}
        run:  |
          set -euo pipefail
          ISSUE_TITLE="Update Portal SDK to v${VERSION}"
          ISSUE_BODY="Automated SDK update detected. 

          **Version:** ${VERSION}
          **Pull Request:** #${PR_NUMBER}

          This issue tracks the update of Portal SDK to version ${VERSION}.

          Related PR:  ${PR_URL}"

          # Create issue with sdk-update label
          gh issue create --title "$ISSUE_TITLE" --body "$ISSUE_BODY" --label "sdk-update" || {
            # If label doesn't exist, create it first
            gh label create "sdk-update" --description "SDK update tracking" --color "0366d6" || true
            gh issue create --title "$ISSUE_TITLE" --body "$ISSUE_BODY" --label "sdk-update"
          }

  create-release:
    name: Create tag and release
    runs-on: ubuntu-latest
    needs: [check-update, sync-sdk]
    if: ${{ needs.sync-sdk.outputs. branch != '' }}
    steps: 
      - name: Checkout version branch
        uses: actions/checkout@v4
        with: 
          ref: ${{ needs. sync-sdk.outputs.branch }}
          persist-credentials: true
          fetch-depth: 0

      - name: Create tag and push
        env:
          VERSION:  ${{ needs.check-update. outputs.version }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"
          git config user. name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -f "$TAG"
          git push -f origin "$TAG"
          echo "Created tag:  $TAG"

      - name:  Create GitHub Release
        uses: softprops/action-gh-release@v2
        with: 
          tag_name: v${{ needs.check-update.outputs. version }}
          name: v${{ needs.check-update.outputs.version }}
          body: |
            ## Portal SDK v${{ needs.check-update.outputs. version }}

            Automated import from official Portal SDK.

            ### Included content:
            **Folders:**
            - FbExportData/levels/
            - GodotProject/levels/
            - GodotProject/objects/
            - GodotProject/scripts/
            - GodotProject/static/
            - mods/

            **Files:**
            - sdk.version.json
            - tsconfig.json
            - package.json
            - package-lock.json
            - README.html
            - requirements.txt
            - versions.json

            **Source:** https://download.portal.battlefield.com/PortalSDK.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  no-update:
    name: No update needed
    runs-on: ubuntu-latest
    needs: [check-update]
    if: ${{ needs.check-update.outputs.update_needed != 'true' }}
    steps:
      - run: echo "No update needed. Local versions. json matches remote. Skipping sync."
